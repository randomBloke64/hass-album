### 功能
本项目是home assistant的一个插件。用于配合HassAPP实现自动上传相册图片。

功能列表：

#### 上传文件

##### 接口

@POST("/api/alumb/sync")

##### 参数

* user: 相册所属用户（插件将在根目录下为每个user创建独立的文件夹，操作均基于该文件夹）；
* path: 上传的文件的绝对路径，插件将在服务端按照该路径在用户目录下保存文件；
* md5: 上传文件的md5码，用于判断文件是否存在且相同。本来是想做HTTP 100指令确认文件是否存在，存在则跳过功能的，但是在home assistant下无法收到100-contine请求，所以该插件中跳过功能无效；
* override: 如果文件存在，并且md5相等，则静默返回成功；如果md5不想等，指定了该参数，则直接覆盖原文件；否则报错，APP端体现为上传失败，错误原因为文件存在；
* time: 客户端文件的最后修改时间，插件将尝试修改上传完成后的文件的最后修改时间为次时间。

#### 删除文件

##### 接口

@DELETE("/api/alumb/sync")

##### 参数

* user: 相册所属用户;
* path: 需要删除的文件的完整路径，插件将在服务端按照该路径在用户目录下搜索并删除。

#### 文件列表

##### 接口

@GET("/api/alumb/list")

##### 参数

* user: 相册所属用户;
* path: 需要返回文件列表的目录路径，从用户文件夹下开始的完整路径；
* wanttime: 是否返回时间，如果该参数存在，插件将逐一读取文件的最后修改时间和访问时间后返回，接口响应将比较慢。

#### 文件存在检查

##### 接口

@Headers("Content-Type: application/json")
@PUT("/api/alumb/check")

##### 参数

* user: 相册所属用户;
* http body

``` json
[
    {
        "path": "",
        "md5": ""
    },
    {
        "path": "",
        "md5": ""
    }
]
```

该接口将逐一判断请求消息体中的列表的文件是否存在已经md5是否吻合，然后返回字符串数组，表示服务端存在并且MD5值一致的文件列表，客户端可以通过该列表删除本地文件释放本地存储。

#### 文件预览

##### 接口

@GET("/api/alumb/preview")

##### 参数

* user: 相册所属用户;
* path: 需要预览的文件的完整路径，插件将在服务端按照该路径在用户目录下搜索并返回，支持bytes: 头请求，也就是说支持mp4文件的索引读取。

#### 文件下载

##### 接口

@Streaming
@GET("/api/alumb/download")

##### 参数

* user: 相册所属用户;
* path: 需要预览的文件的完整路径，插件将在服务端按照该路径在用户目录下搜索并返回完整文件。

### 安装
1. 下载项目，将custom_components文件夹复制到home assistant的配置所在目录。
2. 在home assistant的配置文件configuration.yaml中添加配置项目

``` yaml
album:
  storage_path: \\192.168.1.1\photo
```

只有一个配置项：

* storage_path为相册最终保存的根目录。插件会为每个客户端用户（在APP端设置）在该根目录下创建独立的目录。

### APP端设置

![APP端设置截图](https://github.com/yunsean/hass-album/blob/main/assets/1.jpg?raw=true)

* APP端可以选择需要监视的目录，将自动上传该目录中的所有文件（.开头的隐藏文件会被忽略）
* 可以配置上传方式：
  * 不启用：需要手动点击上传
  * 限定WIFI：只有在指定的WIFI网络才上传（比如设置家庭WIFI下）
  * 仅WIFI：只要连接到WIFI就开始上传
  * 所有网络：任何网络都可以上传
* 扫描时间间隔：设置最小扫描时间间隔（避免每次遍历目录浪费电能）
* 最早时间：将不扫描上传早于该时间之前的文件。